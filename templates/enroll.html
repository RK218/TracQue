
{% extends "_base.html" %}
{% block title %}Enroll New Student{% endblock %}

{% block styles %}
<style>
    #capture-status { margin-top: 15px; }
    #progress-bar { width: 100%; background-color: #e0e0e0; border-radius: 5px; overflow: hidden; margin-top: 10px; }
    #progress { width: 0%; height: 20px; background-color: #4CAF50; text-align: center; line-height: 20px; color: white; transition: width 0.1s ease-in-out; }
</style>
{% endblock %}

{% block content %}
    <h1>Enroll New Student</h1>
    <div class="card">
        <h2>Step 1: Enter Student Details</h2>
        <form id="enroll-form">
            <input type="text" id="student_id" placeholder="Enter Student ID (e.g., S101, ALPHA-01)" required class="form-control mb-2">
            <input type="text" id="name" placeholder="Enter Student Name (e.g., Jane Doe)" required class="form-control mb-2">
            <input type="text" id="parent_phone" placeholder="Enter Parent Phone Number" required class="form-control mb-2">
        </form>
    </div>
    <div class="card">
        <h2>Step 2: Capture 30 Face Images</h2>
        <div style="position:relative;">
            <video id="video" width="640" height="480" autoplay muted playsinline style="border-radius: 10px; max-width: 100%; height: auto; background:#222;"></video>
            <div id="webcam-error-message" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); color:#fff; z-index:2; align-items:center; justify-content:center; text-align:center; font-size:1.2em; padding:40px; border-radius:10px;">
                <b>Webcam not available.</b><br>
                Please check:<br>
                - Camera permissions in your browser<br>
                - No other app is using the camera<br>
                - Try refreshing the page or using a different browser<br>
                <span id="webcam-error-details" style="font-size:0.9em; color:#ffb3b3;"></span>
            </div>
        </div>
        <button id="capture" class="button">Start Face Capture</button>
        <div id="capture-status">
            <p>Images Captured: <span id="count">0</span>/30</p>
            <div id="progress-bar"><div id="progress">0%</div></div>
        </div>
    </div>
    <div class="card fingerprint-section" id="fingerprint-section" style="display:none;">
        <h2><i class="fas fa-fingerprint"></i> Step 3: Enroll Fingerprint (Optional)</h2>
        <p>Enroll fingerprint for quick attendance marking</p>
        <div id="fingerprint-icon">
            <i class="fas fa-fingerprint"></i>
        </div>
        <div class="fingerprint-prompt" id="fingerprint-prompt">
            Ready to enroll fingerprint
        </div>
        <div class="fingerprint-status" id="fingerprint-status">
            <strong>Status:</strong> <span id="fp-status-text">Not started</span>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="enroll-fingerprint-btn" class="button success" style="margin-right: 10px;">
                <i class="fas fa-fingerprint"></i> Enroll Fingerprint
            </button>
            <button id="skip-fingerprint-btn" class="button secondary">
                <i class="fas fa-forward"></i> Skip Fingerprint
            </button>
            <a href="{{ url_for('fingerprint_attendance_page') }}" class="button" style="margin-left: 10px; background: #6a82fb; color: white;">
                <i class="fas fa-arrow-right"></i> Go to Fingerprint Attendance
            </a>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('video');
    const captureButton = document.getElementById('capture');
    const countSpan = document.getElementById('count');
    const progressDiv = document.getElementById('progress');
    const fingerprintSection = document.getElementById('fingerprint-section');
    const enrollFingerprintBtn = document.getElementById('enroll-fingerprint-btn');
    const skipFingerprintBtn = document.getElementById('skip-fingerprint-btn');
    const fingerprintPrompt = document.getElementById('fingerprint-prompt');
    const fpStatusText = document.getElementById('fp-status-text');

    let capturedImages = [];
    let currentStudentId = '';
    let currentStudentName = '';

    function startWebcam() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            window.showNotification('Webcam not supported in this browser.', 'error');
            console.error('Webcam not supported: navigator.mediaDevices.getUserMedia is undefined');
            return;
        }
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.addEventListener('loadedmetadata', () => {
                    captureButton.disabled = false;
                });
                console.log('Webcam stream started successfully.');
            })
            .catch(err => {
                window.showNotification('Could not access webcam. Please check permissions and ensure no other app is using the camera.', 'error');
                console.error('Webcam error:', err);
                captureButton.disabled = true;
            });
    }
    captureButton.disabled = true;
    startWebcam();

    let captureInterval = null;
    let isCapturing = false;

    captureButton.addEventListener('click', () => {
        const studentId = document.getElementById('student_id').value.trim();
        const name = document.getElementById('name').value.trim();
        if (!studentId || !name) {
            window.showNotification('Please enter both Student ID and Name.', 'error');
            return;
        }
        if (!video.srcObject) {
            window.showNotification('Webcam stream not ready. Attempting to start camera again...', 'error');
            // Try to re-initialize the webcam
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.addEventListener('loadedmetadata', () => {
                        captureButton.disabled = false;
                    });
                    window.showNotification('Webcam started. Please try capturing again.', 'success');
                })
                .catch(err => {
                    window.showNotification('Could not access webcam. Please check permissions and ensure no other app is using the camera.', 'error');
                    console.error('Webcam error:', err);
                    captureButton.disabled = true;
                });
            return;
        }
        currentStudentId = studentId;
        currentStudentName = name;
        captureButton.textContent = 'Capturing...';
        captureButton.disabled = true;
        const canvas = document.createElement('canvas');
        canvas.width = 640;
        canvas.height = 480;
        const context = canvas.getContext('2d');
        let count = 0;
        capturedImages = [];
        isCapturing = true;
        captureInterval = setInterval(() => {
            if (count < 30 && isCapturing) {
                try {
                    context.drawImage(video, 0, 0, 640, 480);
                    capturedImages.push(canvas.toDataURL('image/jpeg', 0.8));
                } catch (e) {
                    window.showNotification('Error capturing image from webcam.', 'error');
                    clearInterval(captureInterval);
                    isCapturing = false;
                    return;
                }
                count++;
                countSpan.textContent = count;
                const percentage = Math.round((count / 30) * 100);
                progressDiv.style.width = `${percentage}%`;
                progressDiv.textContent = `${percentage}%`;
            } else {
                clearInterval(captureInterval);
                isCapturing = false;
                sendImagesToServer(studentId, name, capturedImages);
            }
        }, 150);
    });

    function sendImagesToServer(studentId, name, images) {
        const parentPhone = document.getElementById('parent_phone').value.trim();
        const payload = { student_id: studentId, name: name, parent_phone: parentPhone, images: images };
        
        captureButton.textContent = 'Uploading...';

        fetch("{{ url_for('capture_faces') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Face capture response:', data); // DEBUG LOG
            window.showNotification(data.message, data.status);
            if(data.status === 'success') {
                captureButton.textContent = 'Face Capture Complete âœ“';
                // Show fingerprint enrollment section if backend says so
                if (data.show_fingerprint) {
                    fingerprintSection.style.display = 'block';
                    fingerprintSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.warn('show_fingerprint flag missing or false in response:', data);
                }
            } else {
                captureButton.textContent = 'Start Face Capture';
                captureButton.disabled = false;
            }
        })
        .catch(error => {
            window.showNotification('An error occurred during enrollment.', 'error');
            console.error('Fetch Error:', error);
            captureButton.textContent = 'Start Face Capture';
            captureButton.disabled = false;
        });
    }
    
    // Fingerprint Enrollment
    let statusInterval = null;
    
    enrollFingerprintBtn.addEventListener('click', async () => {
        enrollFingerprintBtn.disabled = true;
        skipFingerprintBtn.disabled = true;
        fpStatusText.textContent = 'Activating fingerprint sensor...';
        
        try {
            // Activate fingerprint sensor
            const activateResponse = await fetch('/fingerprint_activate', { method: 'POST' });
            const activateData = await activateResponse.json();
            
            if (!activateData.success) {
                window.showNotification('Fingerprint sensor not available', 'error');
                fpStatusText.textContent = 'Sensor not available';
                enrollFingerprintBtn.disabled = false;
                skipFingerprintBtn.disabled = false;
                return;
            }
            
            fpStatusText.textContent = 'Sensor activated. Starting enrollment...';
            fingerprintPrompt.textContent = 'Initializing...';
            
            // Start polling for enrollment status updates FIRST
            statusInterval = setInterval(async () => {
                try {
                    const statusResponse = await fetch('/enrollment_status');
                    const statusData = await statusResponse.json();
                    
                    if (statusData.messages && statusData.messages.length > 0) {
                        const lastMessage = statusData.messages[statusData.messages.length - 1];
                        fingerprintPrompt.textContent = lastMessage.message;
                        
                        if (lastMessage.type === 'prompt') {
                            fpStatusText.textContent = 'ðŸ‘† Follow the prompts below...';
                        } else if (lastMessage.type === 'status') {
                            fpStatusText.textContent = lastMessage.message;
                        } else if (lastMessage.type === 'success') {
                            fpStatusText.textContent = 'âœ“ ' + lastMessage.message;
                        } else if (lastMessage.type === 'error') {
                            fpStatusText.textContent = 'âŒ ' + lastMessage.message;
                        }
                    }
                } catch (error) {
                    console.error('Status polling error:', error);
                }
            }, 300);  // Poll every 300ms for faster updates
            
            // Start enrollment (this will block, but polling continues in background)
            fetch('/enroll_fingerprint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ student_id: currentStudentId })
            })
            .then(response => response.json())
            .then(enrollData => {
                // Stop polling when enrollment completes
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
                
                if (enrollData.success) {
                    fpStatusText.textContent = 'âœ… Fingerprint enrolled successfully!';
                    fingerprintPrompt.textContent = 'âœ“ Enrollment Complete';
                    window.showNotification('Fingerprint enrolled successfully!', 'success');
                    
                    // Deactivate sensor and redirect
                    setTimeout(async () => {
                        await fetch('/fingerprint_deactivate', { method: 'POST' });
                        window.location.href = "{{ url_for('index') }}";
                    }, 2000);
                } else {
                    fpStatusText.textContent = 'âŒ Enrollment failed: ' + enrollData.message;
                    fingerprintPrompt.textContent = 'Please try again';
                    enrollFingerprintBtn.disabled = false;
                    skipFingerprintBtn.disabled = false;
                    window.showNotification('Fingerprint enrollment failed: ' + enrollData.message, 'error');
                    
                    // Deactivate sensor
                    fetch('/fingerprint_deactivate', { method: 'POST' });
                }
            })
            .catch(error => {
                // Stop polling on error
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
                
                console.error('Fingerprint enrollment error:', error);
                fpStatusText.textContent = 'âŒ Error during enrollment';
                fingerprintPrompt.textContent = 'Connection error - please try again';
                window.showNotification('Error during fingerprint enrollment', 'error');
                enrollFingerprintBtn.disabled = false;
                skipFingerprintBtn.disabled = false;
                
                // Try to deactivate sensor
                fetch('/fingerprint_deactivate', { method: 'POST' }).catch(e => {});
            });
            
        } catch (error) {
            // Stop polling on error
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            
            console.error('Fingerprint enrollment error:', error);
            fpStatusText.textContent = 'âŒ Error during enrollment';
            window.showNotification('Error during fingerprint enrollment', 'error');
            enrollFingerprintBtn.disabled = false;
            skipFingerprintBtn.disabled = false;
            
            // Try to deactivate sensor
            try {
                await fetch('/fingerprint_deactivate', { method: 'POST' });
            } catch (e) {}
        }
    });
    
    // Skip fingerprint enrollment
    skipFingerprintBtn.addEventListener('click', () => {
        window.location.href = "{{ url_for('index') }}";
    })
});
</script>
{% endblock %}